@{
    ViewBag.Title = "RegistroSocialVista";
}

<div class="container">
    <!-- Título -->
    <div class="row">
        <div class="col text-center">
            <h3>FICHA DE ENTREVISTA SOCIAL</h3>
        </div>
    </div>

    <!-- Datos Generales -->
    <h5 class="mt-4">Datos Generales</h5>
    <div class="row">
        <div class="col-md-3">
            <label>Fecha de Ingreso:</label>
            <input type="text" id="fechaIngreso" class="form-control" readonly />
        </div>
        <div class="col-md-3">
            <label>Fecha de Aplicación:</label>
            <input type="text" id="fechaAplicacion" class="form-control" readonly />
        </div>
        <div class="col-md-3">
            <label>Servicio:</label>
            <input type="text" id="servicio" class="form-control" readonly />
        </div>
        <div class="col-md-3">
            <label>Cama:</label>
            <input type="text" id="cama" class="form-control" readonly />
        </div>
    </div>




    <!-- Datos del Paciente -->
    <h5 class="mt-4">Datos del Paciente</h5>
    <div class="row">
        <div class="col-md-3">
            <label>Nombre:</label>
            <input type="text" id="nombrePaciente" class="form-control" readonly />
        </div>
        <div class="col-md-3">
            <label>DNI:</label>
            <input type="text" id="dni" class="form-control" readonly />
        </div>
        <div class="col-md-3">
            <label>Edad:</label>
            <input type="number" id="edad" class="form-control" readonly />
        </div>
        <div class="col-md-3">
            <label>Estado Civil:</label>
            <input type="text" id="estadoCivil" class="form-control" readonly />
        </div>
        <div class="col-md-3 mt-2">
            <label>Grado de Instrucción:</label>
            <input type="text" id="gradoInstruccion" class="form-control" readonly />
        </div>
        <div class="col-md-3 mt-2">
            <label>Dirección:</label>
            <input type="text" id="direccion" class="form-control" readonly />
        </div>
        <div class="col-md-3 mt-2">
            <label>Celular:</label>
            <input type="tel" id="celular" class="form-control" readonly />
        </div>
        <div class="col-md-3 mt-2">
            <label>Ocupación:</label>
            <input type="text" id="ocupacion" class="form-control" readonly />
        </div>
        <div class="col-md-4 mt-2">
            <label>Número de Hijos:</label>
            <input type="number" id="numHijos" class="form-control" readonly />
        </div>
        <div class="col-md-4 mt-2">
            <label>Número de Hermanos:</label>
            <input type="number" id="numHermanos" class="form-control" readonly />
        </div>
        <div class="col-md-4 mt-2">
            <label>Seguro:</label>
            <input type="text" id="seguro" class="form-control" readonly />
        </div>

    </div>

    <div class="row">

        <div class="mt-2">
            <label>Dx Médico:</label>

            <textarea class="form-control" rows="2" id="dxMedico" readonly> </textarea>
        </div>
    </div>

    <div class="container">
        <!-- Responsables Section -->
        <h5 class="mt-4">Responsables</h5>
        <div id="responsablesContainer">
            <p>No hay responsables registrados.</p>
        </div>
    </div>


    <div class="row">
        <h5 class="mt-4">Modalidad de ingreso</h5>
        <div class="col-md-6">
            <label>Modalidad de Ingreso:</label>
            <input type="text" id="modalidadIngreso" class="form-control" readonly />
        </div> 
    </div>

    <div class="row">
        <h5 class="mt-4">Tipo de familia</h5>

        <div class="col-md-6">
            <label>Tipo de Familia:</label>
            <input type="text" id="tipoFamilia" class="form-control" readonly />
        </div>


        <div class="col-md-6">
            <label>Acciones Realizadas:</label>
            <input type="text" id="accionesRealizadas" class="form-control" readonly />
        </div>

        <div class="">
            <label>Observaciones tipo de familia:</label>
            <textarea class="form-control" rows="2" id="observacionesTipoFamilia" readonly> </textarea>
        </div>


    </div>
    <!-- Diagnóstico Social -->
    <h5 class="mt-4 ">Diagnóstico Social</h5>
    <div class="row mb-4">
        <div class="col-md-12">
            <label>Diagnóstico Social:</label>
            <textarea id="diagnosticoSocial" class="form-control" rows="2" readonly></textarea>
        </div>
    </div>
</div>

<script>

    function convertirFecha(fechaJson) {
        // Extrae el timestamp del formato /Date(...)/
        const timestamp = parseInt(fechaJson.replace(/\/Date\((\d+)\)\//, "$1"), 10);
        const date = new Date(timestamp);

        // Formatea la fecha en YYYY-MM-DD
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0'); // Mes en formato MM
        const day = String(date.getDate()).padStart(2, '0'); // Día en formato DD

        return `${year}-${month}-${day}`;
    }

    function obtenerParametroUrl(nombre) {
        const urlParams = new URLSearchParams(window.location.search);
        return urlParams.get(nombre);
    } 

    async function cargarDatos() {
        const id = obtenerParametroUrl('id');
        if (!id) {
            alert('ID no especificado en la URL');
            return;
        }

        try {
            const response = await fetch(`/RegistroSocial/traerRegistroSocial/?id=${id}`);
            const data = await response.json();

            // Usa la función convertirFecha para formatear las fechas
            document.getElementById('fechaIngreso').value = convertirFecha(data.datos.FechaIngreso);
            document.getElementById('fechaAplicacion').value = convertirFecha(data.datos.FechaAplicacion);
            document.getElementById('servicio').value = data.datos.Servicio;
            document.getElementById('cama').value = data.datos.Cama;
            document.getElementById('accionesRealizadas').value = data.datos.AccionesRealizadas;
            document.getElementById('observacionesTipoFamilia').value = data.datos.ObservacionesFamilia;
            document.getElementById('modalidadIngreso').value = data.datos.ModalidadIngreso;
            document.getElementById('tipoFamilia').value = data.datos.TipoFamilia;
            document.getElementById('diagnosticoSocial').value = data.datos.DiagnosticoSocial;

            // Resto del código para completar los campos de la vista con otros datos
            document.getElementById('nombrePaciente').value = data.paciente.NombrePaciente;
            document.getElementById('dni').value = data.paciente.DNI;
            document.getElementById('edad').value = data.paciente.Edad;
            document.getElementById('estadoCivil').value = data.paciente.EstadoCivil;
            document.getElementById('gradoInstruccion').value = data.paciente.GradoInstruccion;
            document.getElementById('direccion').value = data.paciente.Direccion;
            document.getElementById('celular').value = data.paciente.CelularPaciente;
            document.getElementById('ocupacion').value = data.paciente.Ocupacion;
            document.getElementById('numHijos').value = data.paciente.NumHijos;
            document.getElementById('numHermanos').value = data.paciente.NumHermanos;
            document.getElementById('seguro').value = data.paciente.Seguro;
            document.getElementById('dxMedico').value = data.paciente.DxMedico;

            // Cargar datos de responsables
            const responsablesContainer = document.getElementById('responsablesContainer');
            responsablesContainer.innerHTML = '';  // Limpiar el contenedor

            if (data.responsables && Array.isArray(data.responsables) && data.responsables.length > 0) {
                data.responsables.forEach((responsable, index) => {
                    const div = document.createElement('div');
                    div.classList.add('row', 'mb-3');
                    div.innerHTML = `
                    <div class="col-md-3">
                        <label>Responsable ${index + 1}:</label>
                        <input type="text" class="form-control" value="${responsable.NombreResponsable}" disabled>
                    </div>
                    <div class="col-md-3">
                        <label>DNI:</label>
                        <input type="text" class="form-control" value="${responsable.DNI}" disabled>
                    </div>
                    <div class="col-md-3">
                        <label>Edad:</label>
                        <input type="number" class="form-control" value="${responsable.Edad}" disabled>
                    </div>
                    <div class="col-md-3">
                        <label>Parentesco:</label>
                        <input type="text" class="form-control" value="${responsable.Parentesco}" disabled>
                    </div>
                    <div class="col-md-3 mt-2">
                        <label>Celular:</label>
                        <input type="tel" class="form-control" value="${responsable.CelularResponsable}" disabled>
                    </div>
                    <div class="col-md-3 mt-2">
                        <label>Ocupación:</label>
                        <input type="text" class="form-control" value="${responsable.Ocupacion}" disabled>
                    </div>
                    <div class="col-md-3 mt-2">
                        <label>Grado de Instrucción:</label>
                        <input type="text" class="form-control" value="${responsable.GradoInstruccion}" disabled>
                    </div>
                `;
                    responsablesContainer.appendChild(div);
                });
            } else {
                responsablesContainer.innerHTML = '<p>No hay responsables registrados.</p>';
            }

        } catch (error) {
            console.error('Error al cargar los datos:', error);
            alert('Error al cargar los datos. Intente nuevamente.');
        }
    }

    window.onload = cargarDatos;

</script>
